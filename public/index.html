<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Klinik Hewan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .nav-link { cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand">VetCare Dashboard</a>
            <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="myTab">
            <li class="nav-item"><a class="nav-link active" onclick="showTab('pets')">Pets Saya</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('booking')">Buat Janji Temu</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('history')">Riwayat Janji</a></li>
        </ul>

        <div id="booking-section" style="display:none;">
            <div class="card p-4 shadow-sm">
                <h3>Booking Dokter Hewan</h3>
                <form id="appointmentForm">
                    <div class="mb-3">
                        <label>Pilih Pet Kamu</label>
                        <select id="selectPet" class="form-control" required></select>
                    </div>
                    <div class="mb-3">
                        <label>Pilih Dokter</label>
                        <select id="selectDoctor" class="form-control" required></select>
                    </div>
                    <div class="mb-3">
                        <label>Layanan</label>
                        <select id="selectService" class="form-control" required></select>
                    </div>
                    <div class="mb-3">
                        <label>Tanggal & Jam</label>
                        <input type="datetime-local" id="bookDate" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-success">Konfirmasi Booking</button>
                </form>
            </div>
        </div>

        <div id="history-section" style="display:none;">
            <h3>Daftar Janji Temu</h3>
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>Pet</th>
                        <th>Dokter</th>
                        <th>Layanan</th>
                        <th>Tanggal</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="appointmentList"></tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        function showTab(tab) {
            document.getElementById('booking-section').style.display = tab === 'booking' ? 'block' : 'none';
            document.getElementById('history-section').style.display = tab === 'history' ? 'block' : 'none';
            if(tab === 'booking') loadDropdowns();
            if(tab === 'history') loadAppointments();
        }

        // Fungsi ambil data untuk Dropdown
        async function loadDropdowns() {
            // Load Pets
            const resPets = await fetch('/api/pets', { headers: { 'Authorization': `Bearer ${token}` } });
            const pets = await resPets.json();
            document.getElementById('selectPet').innerHTML = pets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            // Load Doctors
            const resDocs = await fetch('/api/doctors');
            const docs = await resDocs.json();
            document.getElementById('selectDoctor').innerHTML = docs.map(d => `<option value="${d.id}">${d.name} (${d.specialization})</option>`).join('');

            // Load Services
            const resServ = await fetch('/api/services');
            const servs = await resServ.json();
            document.getElementById('selectService').innerHTML = servs.map(s => `<option value="${s.id}">${s.name} - Rp${s.price}</option>`).join('');
        }

        // Simpan Janji Temu
        document.getElementById('appointmentForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                pet_id: document.getElementById('selectPet').value,
                doctor_id: document.getElementById('selectDoctor').value,
                service_id: document.getElementById('selectService').value,
                date: document.getElementById('bookDate').value
            };

            const res = await fetch('/api/appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('Berhasil booking!');
                showTab('history');
            }
        };

        async function loadAppointments() {
            const res = await fetch('/api/appointments', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('appointmentList').innerHTML = data.map(a => `
                <tr>
                    <td>${a.pet_name}</td>
                    <td>${a.doctor_name}</td>
                    <td>${a.service_name}</td>
                    <td>${new Date(a.date).toLocaleString()}</td>
                    <td><span class="badge bg-warning">${a.status}</span></td>
                </tr>
            `).join('');
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>