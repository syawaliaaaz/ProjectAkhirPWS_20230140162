<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetCare Dashboard üêæ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #27ae60; --dark-color: #2c3e50; }
        body { background-color: #f4f7f6; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-tabs .nav-link { color: var(--dark-color); cursor: pointer; font-weight: 500; }
        .nav-tabs .nav-link.active { color: var(--primary-color) !important; border-bottom: 3px solid var(--primary-color) !important; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-primary { background-color: var(--primary-color); border: none; }
        .btn-primary:hover { background-color: #219150; }
        .admin-badge { background-color: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand"><b>PetCare Dashboard üêæ</b></a>
            <div class="d-flex align-items-center">
                <span id="userDisplay" class="text-white me-3"></span>
                <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item"><a class="nav-link active" onclick="showTab('pets')">Data Pets</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('booking')">Buat Janji Temu</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('history')">Riwayat Janji</a></li>
            <li id="adminTab" class="nav-item" style="display:none;"><a class="nav-link" onclick="showTab('admin')">Admin Panel</a></li>
        </ul>

        <div id="pets-section" class="tab-content">
            <div class="card p-4 mb-4">
                <h4>Tambah Pet Baru</h4>
                <div class="row g-2">
                    <div class="col-md-4"><input type="text" id="petName" class="form-control" placeholder="Nama Hewan"></div>
                    <div class="col-md-3"><input type="text" id="petSpecies" class="form-control" placeholder="Spesies (Kucing/Anjing)"></div>
                    <div class="col-md-2"><input type="number" id="petAge" class="form-control" placeholder="Umur"></div>
                    <div class="col-md-3"><button class="btn btn-primary w-100" onclick="addPet()">Simpan Pet</button></div>
                </div>
            </div>
            <div class="card p-4">
                <table class="table table-hover">
                    <thead><tr><th>Nama</th><th>Spesies</th><th>Umur</th><th>Aksi</th></tr></thead>
                    <tbody id="petTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="booking-section" class="tab-content" style="display:none;">
            <div class="card p-4 mx-auto" style="max-width: 600px;">
                <h3 class="text-center mb-4">Reservasi Dokter</h3>
                <form id="appointmentForm">
                    <div class="mb-3"><label>Pilih Hewan</label><select id="selectPet" class="form-select" required></select></div>
                    <div class="mb-3"><label>Pilih Dokter</label><select id="selectDoctor" class="form-select" required></select></div>
                    <div class="mb-3"><label>Jenis Layanan</label><select id="selectService" class="form-select" required></select></div>
                    <div class="mb-3"><label>Tanggal & Jam</label><input type="datetime-local" id="bookDate" class="form-control" required></div>
                    <button type="submit" class="btn btn-primary w-100">Konfirmasi Booking</button>
                </form>
            </div>
        </div>

        <div id="history-section" class="tab-content" style="display:none;">
            <div class="card p-4">
                <h3>Riwayat Janji Temu</h3>
                <table class="table table-striped">
                    <thead><tr><th>Pet</th><th>Dokter</th><th>Layanan</th><th>Waktu</th><th>Status</th></tr></thead>
                    <tbody id="appointmentTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-section" class="tab-content" style="display:none;">
            <div class="alert alert-info">Selamat Datang Admin! Anda bisa menambah data master di sini.</div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-3 mb-3">
                        <h5>+ Tambah Dokter</h5>
                        <input type="text" id="docName" class="form-control mb-2" placeholder="Nama Dokter">
                        <input type="text" id="docSpec" class="form-control mb-2" placeholder="Spesialisasi">
                        <button class="btn btn-dark btn-sm" onclick="addDoctor()">Tambah</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3">
                        <h5>+ Tambah Layanan</h5>
                        <input type="text" id="servName" class="form-control mb-2" placeholder="Nama Layanan">
                        <input type="number" id="servPrice" class="form-control mb-2" placeholder="Harga (Rp)">
                        <button class="btn btn-dark btn-sm" onclick="addService()">Tambah</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        const payload = JSON.parse(atob(token.split('.')[1]));
        const userRole = payload.role;

        document.getElementById('userDisplay').innerHTML = `Halo, ${payload.email} <span class="admin-badge">${userRole}</span>`;
        if (userRole === 'admin') document.getElementById('adminTab').style.display = 'block';

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tab}-section`).style.display = 'block';
            event.target.classList.add('active');

            if (tab === 'pets') loadPets();
            if (tab === 'booking') loadDropdowns();
            if (tab === 'history') loadAppointments();
        }

        // --- CRUD PETS ---
        async function loadPets() {
            const res = await fetch('/api/pets', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('petTableBody').innerHTML = data.map(p => `
                <tr><td>${p.name}</td><td>${p.species}</td><td>${p.age}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deletePet(${p.id})">Hapus</button></td></tr>
            `).join('');
        }

        async function addPet() {
            const name = document.getElementById('petName').value;
            const species = document.getElementById('petSpecies').value;
            const age = document.getElementById('petAge').value;
            await fetch('/api/pets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, species, age })
            });
            loadPets();
        }

        // --- BOOKING LOGIC ---
        async function loadDropdowns() {
            const [pets, docs, servs] = await Promise.all([
                fetch('/api/pets', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                fetch('/api/doctors', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                fetch('/api/services', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
            ]);

            document.getElementById('selectPet').innerHTML = pets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('selectDoctor').innerHTML = docs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            document.getElementById('selectService').innerHTML = servs.map(s => `<option value="${s.id}">${s.name} (Rp${s.price})</option>`).join('');
        }

        document.getElementById('appointmentForm').onsubmit = async (e) => {
            e.preventDefault();
            const body = {
                pet_id: document.getElementById('selectPet').value,
                doctor_id: document.getElementById('selectDoctor').value,
                service_id: document.getElementById('selectService').value,
                date: document.getElementById('bookDate').value
            };
            const res = await fetch('/api/appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            if(res.ok) alert('Booking Berhasil!');
            showTab('history');
        };

        async function loadAppointments() {
            const res = await fetch('/api/appointments', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            document.getElementById('appointmentTableBody').innerHTML = data.map(a => `
                <tr><td>${a.pet_name}</td><td>${a.doctor_name}</td><td>${a.service_name}</td>
                <td>${new Date(a.date).toLocaleString()}</td><td><span class="badge bg-info">${a.status}</span></td></tr>
            `).join('');
        }

        // --- ADMIN ONLY ---
        async function addDoctor() {
            const body = { name: document.getElementById('docName').value, specialization: document.getElementById('docSpec').value };
            await fetch('/api/doctors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            alert('Dokter Ditambahkan!');
        }

        async function addService() {
            const body = { name: document.getElementById('servName').value, price: document.getElementById('servPrice').value };
            await fetch('/api/services', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            alert('Layanan Ditambahkan!');
        }

        function logout() { localStorage.clear(); window.location.href = '/login.html'; }
        
        loadPets(); // Init
    </script>
</body>
</html>