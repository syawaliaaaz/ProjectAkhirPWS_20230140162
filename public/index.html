<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetCare Dashboard üêæ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #27ae60; --dark-color: #2c3e50; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-tabs .nav-link { color: var(--dark-color); cursor: pointer; font-weight: 500; border: none; }
        .nav-tabs .nav-link.active { color: var(--primary-color) !important; border-bottom: 3px solid var(--primary-color) !important; background: transparent; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-primary { background-color: var(--primary-color); border: none; }
        .btn-primary:hover { background-color: #219150; }
        .admin-badge { background-color: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .tab-content-item { display: none; }
        .tab-content-item.active { display: block; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand"><b>PetCare Dashboard üêæ</b></a>
            <div class="d-flex align-items-center">
                <span id="userDisplay" class="text-white me-3"></span>
                <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item"><a class="nav-link active" onclick="showTab('pets', this)">Data Pets</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('booking', this)">Buat Janji Temu</a></li>
            <li class="nav-item"><a class="nav-link" onclick="showTab('history', this)">Riwayat Janji</a></li>
            <li id="adminTab" class="nav-item" style="display:none;"><a class="nav-link" onclick="showTab('admin', this)">Admin Panel</a></li>
        </ul>

        <div id="pets-section" class="tab-content-item active">
            <div class="card p-4 mb-4">
                <h4>Tambah Pet Baru</h4>
                <form id="petForm" class="row g-2">
                    <div class="col-md-4"><input type="text" id="petName" class="form-control" placeholder="Nama Hewan" required></div>
                    <div class="col-md-3"><input type="text" id="petSpecies" class="form-control" placeholder="Spesies (Kucing/Anjing)" required></div>
                    <div class="col-md-2"><input type="number" id="petAge" class="form-control" placeholder="Umur" required></div>
                    <div class="col-md-3"><button type="submit" class="btn btn-primary w-100">Simpan Pet</button></div>
                </form>
            </div>
            <div class="card p-4">
                <table class="table table-hover text-center">
                    <thead class="table-light"><tr><th>Nama</th><th>Spesies</th><th>Umur</th><th>Aksi</th></tr></thead>
                    <tbody id="petTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="booking-section" class="tab-content-item">
            <div class="card p-4 mx-auto" style="max-width: 600px;">
                <h3 class="text-center mb-4">Reservasi Dokter</h3>
                <form id="appointmentForm">
                    <div class="mb-3"><label class="form-label">Pilih Hewan</label><select id="selectPet" class="form-select" required></select></div>
                    <div class="mb-3"><label class="form-label">Pilih Dokter</label><select id="selectDoctor" class="form-select" required></select></div>
                    <div class="mb-3"><label class="form-label">Jenis Layanan</label><select id="selectService" class="form-select" required></select></div>
                    <div class="mb-3"><label class="form-label">Tanggal & Jam</label><input type="datetime-local" id="bookDate" class="form-control" required></div>
                    <button type="submit" class="btn btn-primary w-100">Konfirmasi Booking</button>
                </form>
            </div>
        </div>

        <div id="history-section" class="tab-content-item">
            <div class="card p-4">
                <h3 class="mb-4">Riwayat Janji Temu</h3>
                <div class="table-responsive">
                    <table class="table table-striped align-middle">
                        <thead class="table-dark"><tr><th>Pet</th><th>Dokter</th><th>Layanan</th><th>Waktu</th><th>Status</th></tr></thead>
                        <tbody id="appointmentTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="admin-section" class="tab-content-item">
            <div class="alert alert-info"><b>Mode Admin:</b> Kelola data Master Dokter dan Layanan.</div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card p-3 h-100">
                        <h5>+ Tambah Dokter</h5>
                        <input type="text" id="docName" class="form-control mb-2" placeholder="Nama Dokter">
                        <input type="text" id="docSpec" class="form-control mb-2" placeholder="Spesialisasi">
                        <button class="btn btn-dark w-100" onclick="addDoctor()">Tambah Dokter</button>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card p-3 h-100">
                        <h5>+ Tambah Layanan</h5>
                        <input type="text" id="servName" class="form-control mb-2" placeholder="Nama Layanan">
                        <input type="number" id="servPrice" class="form-control mb-2" placeholder="Harga (Rp)">
                        <button class="btn btn-dark w-100" onclick="addService()">Tambah Layanan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';

        // Validasi Token & Role
        let userRole = 'user';
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            userRole = payload.role;
            document.getElementById('userDisplay').innerHTML = `Halo, ${payload.email} <span class="admin-badge">${userRole.toUpperCase()}</span>`;
            if (userRole === 'admin') document.getElementById('adminTab').style.display = 'block';
        } catch (e) {
            logout();
        }

        // --- NAVIGATION ---
        function showTab(tabId, el) {
            document.querySelectorAll('.tab-content-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`${tabId}-section`).classList.add('active');
            el.classList.add('active');

            if (tabId === 'pets') loadPets();
            if (tabId === 'booking') loadDropdowns();
            if (tabId === 'history') loadAppointments();
        }

        // --- CRUD PETS ---
        async function loadPets() {
            try {
                const res = await fetch('/api/pets', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                document.getElementById('petTableBody').innerHTML = data.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.species}</td>
                        <td>${p.age} Tahun</td>
                        <td><button class="btn btn-outline-danger btn-sm" onclick="deletePet(${p.id})">Hapus</button></td>
                    </tr>
                `).join('');
            } catch (err) { console.error(err); }
        }

        document.getElementById('petForm').onsubmit = async (e) => {
            e.preventDefault();
            const body = {
                name: document.getElementById('petName').value,
                species: document.getElementById('petSpecies').value,
                age: document.getElementById('petAge').value
            };
            await fetch('/api/pets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            document.getElementById('petForm').reset();
            loadPets();
        };

        async function deletePet(id) {
            if (confirm('Hapus data pet ini?')) {
                await fetch(`/api/pets/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadPets();
            }
        }

        // --- BOOKING ---
        async function loadDropdowns() {
            try {
                const [pets, docs, servs] = await Promise.all([
                    fetch('/api/pets', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                    fetch('/api/doctors', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                    fetch('/api/services', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
                ]);

                document.getElementById('selectPet').innerHTML = pets.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                document.getElementById('selectDoctor').innerHTML = docs.map(d => `<option value="${d.id}">${d.name} (${d.specialization})</option>`).join('');
                document.getElementById('selectService').innerHTML = servs.map(s => `<option value="${s.id}">${s.name} - Rp${s.price.toLocaleString()}</option>`).join('');
            } catch (err) { alert('Gagal memuat data. Pastikan data dokter/layanan sudah diisi oleh admin.'); }
        }

        document.getElementById('appointmentForm').onsubmit = async (e) => {
            e.preventDefault();
            const body = {
                pet_id: document.getElementById('selectPet').value,
                doctor_id: document.getElementById('selectDoctor').value,
                service_id: document.getElementById('selectService').value,
                date: document.getElementById('bookDate').value
            };
            const res = await fetch('/api/appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(body)
            });
            if(res.ok) {
                alert('Booking Berhasil!');
                document.querySelectorAll('.nav-link')[2].click(); // Pindah ke tab riwayat
            }
        };

        async function loadAppointments() {
            try {
                const res = await fetch('/api/appointments', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                document.getElementById('appointmentTableBody').innerHTML = data.map(a => `
                    <tr>
                        <td><b>${a.pet_name}</b></td>
                        <td>${a.doctor_name}</td>
                        <td>${a.service_name}</td>
                        <td>${new Date(a.date).toLocaleString('id-ID')}</td>
                        <td><span class="badge ${a.status === 'pending' ? 'bg-warning text-dark' : 'bg-success'}">${a.status.toUpperCase()}</span></td>
                    </tr>
                `).join('');
            } catch (err) { console.error(err); }
        }

        // --- ADMIN ACTIONS ---
        async function addDoctor() {
            const name = document.getElementById('docName').value;
            const specialization = document.getElementById('docSpec').value;
            if(!name || !specialization) return alert('Isi semua field!');
            
            await fetch('/api/doctors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, specialization })
            });
            alert('Dokter Berhasil Ditambahkan!');
            document.getElementById('docName').value = '';
            document.getElementById('docSpec').value = '';
        }

        async function addService() {
            const name = document.getElementById('servName').value;
            const price = document.getElementById('servPrice').value;
            if(!name || !price) return alert('Isi semua field!');

            await fetch('/api/services', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, price })
            });
            alert('Layanan Berhasil Ditambahkan!');
            document.getElementById('servName').value = '';
            document.getElementById('servPrice').value = '';
        }

        function logout() { localStorage.clear(); window.location.href = '/login.html'; }
        
        // Initial load
        loadPets();
    </script>
</body>
</html>